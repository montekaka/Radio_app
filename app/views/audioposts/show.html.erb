<!--style the display current time section-->
<style type=text/css>
.hr_bottom{
  margin-bottom: 40px;  
}

#DisplayCurrentTime{
  margin: 20px;
  font: "Lucida Grande", Arial, Verdana, sans-serif; 
  text-align:center;
  font-size: 400%;
}
</style>
<!--end-->
<style type=text/css>
  input.ui-slider-input {
    display : none !important;
  }

  #mypanel{
    opacity:0.92;
  }
</style>

<% if notice %>
  <p id="notice"><%= notice %></p>
<% end %>


<!---panel-->
    <div data-role="panel" id="mypanel" data-position="right" data-display="push" data-theme="b">
      <!--Panel for description-->
      <div data-role="header" data-theme="a" class="ui-corner-top">
        <h1><%= @audiopost.title %></h1>
      </div>
      <div data-role="content" data-theme="d" class="ui-corner-bottom ui-content">
        <p id = 'showDate'><strong>Show Date:</strong> <%= @audiopost.audio_date %></p>
        <% if @audiopost.short_note.nil? %>
        <p>
          <button href="#mypanel" data-theme="b" data-rel="close" data-mini="true" data-inline="true" data-icon="delete" data-iconpos="right">
            Close
          </button>        
        </p>
        <% else %>
          <p id='showDescription'>
            <%= @audiopost.short_note.html_safe %>
          </p>
          <p>
            <button href="#mypanel" data-theme="b" data-rel="close" data-mini="true" data-inline="true" data-icon="delete" data-iconpos="right">
              Close
            </button>        
          </p>          
        <% end %>
      </div>
      <!--end Panel for description-->
        <!--panel for jump to the different section content goes here-->
<!--         <h2>Jump to section</h2>
        <div data-role="content">
          <button class= 'audioChapter' data-theme="d" value='0' >
            城市破產
          </button>
          <button class='audioChapter' data-theme="d"  value='960'>
            奧運軍訓
          </button>
          <button href="#mypanel" data-theme="b" data-rel="close">
            Done
          </button>
        </div>
     -->
    <!-- /panel -->
    </div>
<!---panel-->

  <div data-role="header" data-theme="b">   
    <h1>
      <%= @audiopost.title %>
    </h1>
    <%= link_to 'Home', show_audioposts_path(@show), {"class"=>"ui-btn-left", "data-icon" => "home", "data-rel"=>"back"} %>
    <!--tricker the panel-->
    <a href="#mypanel" class="ui-btn-right" data-position-to="window" data-icon="info">About</a>
    <!---->
  </div>
  <div data-role="content">
    
    <hr>
     <p id='DisplayCurrentTime'>00:00</p>
    <hr id="hr_bottom">
    
    <a href="#mypanel" data-role="button" data-icon="arrow-l" data-iconpos="right" data-theme="e"><%= @audiopost.title %></a>  
    <!--Disqus-->
    <div data-role="collapsible" data-theme="e" data-content-theme="c">
      <h3>留言</h3>
      <!-- START: Livefyre Embed -->
        <div id="disqus_thread"></div>
      <!-- END: Livefyre Embed -->
    </div>
    <!--end-->
      <audio class="player" id='audioArchive'>
        <source src=<%= @audiopost.audio %> type='audio/mpeg' id='todaynews'>       
      </audio>
  </div>
  
    <div data-role='footer' data-position="fixed" data-theme="b">
      <table style="margin-left: 5px; margin-right: 5px;" id="sliderTime">
        <tr>
          <td><p id="DisplayRemindTime"></p></td>
          <td width="100%" class="slider-shit">
            <input type="range" name="slider-fill" id="timeControl" value="0" min="0" max="1432" width="100%" data-highlight="true" data-mini="true"/>
          </td>
        </tr>
      </table>
      <div data-role="footer" class="ui-bar" data-theme="b">
        <div data-role="navbar">
          <ul>
            <li>
              <button type="button" id = "playButton" data-theme="b">Play</button>
            </li>
          </ul>
        </div>     
      </div>
    </div>
  </div>
<!--the Time control js-->  
<script>
//fuction to calculate display hours
function displayTime(input_seconds){
  var h = Math.floor(input_seconds/3600);
  input_seconds = input_seconds % 3600;
  var min = Math.floor(input_seconds/60);
  input_seconds = Math.floor(input_seconds % 60);
  if (input_seconds.toString().length < 2) {input_seconds = "0" + input_seconds};
  if (min.toString().length < 2) {min = "0" + min};
  if(h>0){
    var currentPlayingTime = h + ":" + min + ":" + input_seconds;  
  }
  else{
    currentPlayingTime = min + ":" + input_seconds;
  }
  return currentPlayingTime;
};

//ProgressControl function link the play time to display time
function sliderController(audioSource, PlayStopButtonID, DisplayCurrentTimeID, DisplayRemindTimeID, TimeSliderID){
  $(TimeSliderID).val(Math.round(audioSource.currentTime)).slider("refresh");
  $(DisplayCurrentTimeID).html(displayTime($(TimeSliderID).val()));
  $(DisplayRemindTimeID).html("-"+displayTime(audioSource.duration-audioSource.currentTime));
  if(audioSource.currentTime==audioSource.duration){
    $(PlayStopButtonID).text('Play').button('refresh');
  };
};

//ProgressControl function link the slider time to display time
function sliderControllerWithSliderTime(audioSource, PlayStopButtonID, DisplayCurrentTimeID, DisplayRemindTimeID, TimeSliderID){
  //$(TimeSliderID).val(Math.round(audioSource.currentTime)).slider("refresh");
  $(DisplayCurrentTimeID).html(displayTime($(TimeSliderID).val()));
  $(DisplayRemindTimeID).html("-"+displayTime(audioSource.duration-audioSource.currentTime));
  if(audioSource.currentTime==audioSource.duration){
    $(PlayStopButtonID).text('Play').button('refresh');
  };
};

function audioControl(audioSource, PlayStopButtonID, DisplayCurrentTimeID, DisplayRemindTimeID, TimeSliderID){
  if(audioSource.paused){
    console.log('Target Audio is currently at pause mood');
    audioSource.play();
    $(PlayStopButtonID).text('Stop').button('refresh');
    $('audio').bind('timeupdate',function(){
      sliderController(audioSource, PlayStopButtonID, DisplayCurrentTimeID, DisplayRemindTimeID, TimeSliderID);
    });
  }
  else{
    console.log('Target Audio is currently at playing mood');
    audioSource.pause();
    $(PlayStopButtonID).text('Play').button('refresh');
  };
};

$(document).ready(function(){
  var audio = document.getElementById('audioArchive');
  audio.addEventListener("loadedmetadata", function(){

  var playLength = Math.round(audio.duration);
    $('#DisplayCurrentTime').html(displayTime(playLength));
    if(audio.currentTime==0){
      $('#DisplayRemindTime').html("-"+displayTime(playLength));
    };
    $('#timeControl').attr('max', playLength);
    $('#timeControl').slider('refresh');
    
    $('#DisplayCurrentTime').on('tap',function(){
      audioControl(audio,'#playButton','#DisplayCurrentTime', '#DisplayRemindTime', '#timeControl')
    });
    $('#playButton').on('tap',function(){
      audioControl(audio,'#playButton','#DisplayCurrentTime', '#DisplayRemindTime', '#timeControl')
    });

    //slider control the time
    $('#timeControl').on('slidestart',function(){
      if(audio.currentTime==0){
        audio.play();
        audio.pause();
        console.log("The audio has not played any yet, so we will like to init it.");
      }
      else if($('#playButton').text()=="Play"){        
        console.log("The audio has been playing but currently at a pause state, so we do not need to do anything.");
        return 0;
      }
      else{
        console.log("The audio is playing, so we will like to pause it first.");
        audio.pause();
        $('audio').unbind('timeupdate');
        audio.play();
        $('audio').bind('timeupdate', function(){
          sliderControllerWithSliderTime(audio,'#playButton','#DisplayCurrentTime', '#DisplayRemindTime', '#timeControl');
        });
      };
    });
    //end slider start
    //slider change
    $("#timeControl").on('change', function(){    
      $("#DisplayCurrentTime").html(displayTime($("#timeControl").val()));
      if($('#playButton').text()=="Play"){        
        $('#DisplayRemindTime').html("-"+displayTime(audio.duration - $("#timeControl").val()));
      }
    });
    //end slider change
    //slider stop
    $("#timeControl").on('slidestop', function(){
      if(audio.currentTime==0){
        var slider_value = $("#timeControl").val();        
        console.log("update time to " + displayTime(slider_value));
        $('audio').bind('timeupdate', function(){
          sliderControllerWithSliderTime(audio,'#playButton','#DisplayCurrentTime', '#DisplayRemindTime', '#timeControl');
        });        
        audio.currentTime = slider_value;        
      }
      else if($('#playButton').text()=="Play"){      
        var slider_value = $("#timeControl").val();
        console.log("update time to " + displayTime(slider_value));
        audio.currentTime = slider_value;
      }
      else{
        audio.pause();
        $('audio').unbind('timeupdate');
        var slider_value = $("#timeControl").val();
        console.log("Slider stop and update time to " + displayTime(slider_value));
        audio.currentTime = slider_value;
        $('audio').bind('timeupdate',function(){
          sliderController(audio,'#playButton','#DisplayCurrentTime', '#DisplayRemindTime', '#timeControl');
        });        
        audio.play();
      };
    });    
    //end slider stop
    //end slider control
  });
});
</script>
<!--Disqus-->
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'am1300'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
<!--end-->
